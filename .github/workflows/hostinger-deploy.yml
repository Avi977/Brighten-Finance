name: Deploy to Hostinger (SSH/FTP Hybrid)

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-and-deploy:
    name: Build and Deploy to Hostinger
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Prepare deployment files
        run: |
          # Create deployment directory
          mkdir -p deploy

          # Copy all built files
          cp -r out/* deploy/

          # Copy essential server files
          cp public/.htaccess deploy/ 2>/dev/null || echo ".htaccess not found, skipping"
          cp public/robots.txt deploy/ 2>/dev/null || echo "robots.txt not found, skipping"
          cp public/sitemap.xml deploy/ 2>/dev/null || echo "sitemap.xml not found, skipping"

          # Create PHP index for better hosting compatibility
          cat > deploy/index.php << 'EOF'
          <?php
          // Redirect to index.html for static hosting
          if (file_exists('index.html')) {
              include 'index.html';
          } else {
              echo 'Site is being deployed...';
          }
          ?>
          EOF

          # Create deployment info
          echo "Deployed: $(date)" > deploy/deploy-info.txt
          echo "Commit: ${{ github.sha }}" >> deploy/deploy-info.txt
          echo "Repository: ${{ github.repository }}" >> deploy/deploy-info.txt

      - name: Deploy via SSH (Primary Method)
        id: ssh_deploy
        continue-on-error: true
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USERNAME }}
          key: ${{ secrets.HOSTINGER_SSH_PRIVATE_KEY }}
          port: ${{ secrets.HOSTINGER_PORT || 22 }}
          source: "deploy/*"
          target: "/home/${{ secrets.HOSTINGER_USERNAME }}/domains/darkgrey-dunlin-762929.hostingersite.com/public_html"
          strip_components: 1
          overwrite: true

      - name: Set permissions via SSH
        if: steps.ssh_deploy.outcome == 'success'
        continue-on-error: true
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USERNAME }}
          key: ${{ secrets.HOSTINGER_SSH_PRIVATE_KEY }}
          port: ${{ secrets.HOSTINGER_PORT || 22 }}
          script: |
            cd "/home/${{ secrets.HOSTINGER_USERNAME }}/domains/darkgrey-dunlin-762929.hostingersite.com/public_html"
            find . -type f -name "*.html" -exec chmod 644 {} \;
            find . -type f -name "*.php" -exec chmod 644 {} \;
            find . -type f -name "*.css" -exec chmod 644 {} \;
            find . -type f -name "*.js" -exec chmod 644 {} \;
            find . -type f -name ".htaccess" -exec chmod 644 {} \; 2>/dev/null || true
            find . -type d -exec chmod 755 {} \;
            echo "âœ… SSH deployment successful!"

      - name: Deploy via FTP (Fallback Method)
        if: steps.ssh_deploy.outcome == 'failure'
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USERNAME }}
          password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          local-dir: ./deploy/
          server-dir: /domains/darkgrey-dunlin-762929.hostingersite.com/public_html/
          dangerous-clean-slate: true

      - name: Deployment Summary
        run: |
          echo "ğŸš€ Deployment completed!"
          echo "ğŸ“… Deployed at: $(date)"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸŒ Your site should be live at: https://darkgrey-dunlin-762929.hostingersite.com"

          if [ "${{ steps.ssh_deploy.outcome }}" = "success" ]; then
            echo "âœ… Used SSH deployment (faster, more reliable)"
          else
            echo "âœ… Used FTP deployment (SSH not available)"
            echo "ğŸ’¡ To enable SSH: Contact Hostinger support or upgrade hosting plan"
          fi